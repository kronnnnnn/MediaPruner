---
name: Copilot Review (label) on CI success

'on':
  workflow_run:
    workflows:
      - CI
    types:
      - completed
  workflow_dispatch:
    inputs:
      pull_number:
        description: >-
          Optional: PR number to run Copilot review
          against (useful for manual runs)
        required: false
        default: ''

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  copilot_review:
    # Run when CI workflow_run completed successfully for a PR,
    # or when manually dispatched
    if: >-
      ${{ (github.event_name == 'workflow_run' && github.event.workflow_run != null &&
          github.event.workflow_run.conclusion == 'success' &&
          github.event.workflow_run.event == 'pull_request') ||
          github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head (from workflow_run)
        if: >-
          ${{ github.event_name == 'workflow_run' && github.event.workflow_run != null &&
              github.event.workflow_run.pull_requests &&
              github.event.workflow_run.pull_requests[0] }}
        uses: actions/checkout@v4
        with:
          # Use the first associated PR's head SHA so we validate the exact
          # PR commit that CI ran
          ref: >-
            ${{ github.event.workflow_run.pull_requests[0].head.sha }}

      - name: Checkout PR head (manual dispatch)
        if: >-
          ${{ github.event_name == 'workflow_dispatch' &&
              github.event.inputs.pull_number != '' }}
        uses: actions/checkout@v4
        with:
          # Checkout the PR ref for the provided pull number
          ref: >-
            refs/pull/${{ github.event.inputs.pull_number }}/head

      - name: Checkout repository (manual branch dispatch)
        if: >-
          ${{ github.event_name == 'workflow_dispatch' &&
              (!github.event.inputs || github.event.inputs.pull_number == '') }}
        uses: actions/checkout@v4
        with:
          # Checkout the invoked workflow ref (branch or commit)
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Lint frontend
        working-directory: ./frontend
        run: npm run lint

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          # ensure test runner is available
          pip install pytest pytest-asyncio

      - name: Test Python imports
        run: |
          cd backend
          PYTHONPATH=. python -c "from app.main import app; print('OK')"


      - name: Run backend tests
        working-directory: ./backend
        run: |
          PYTHONPATH=. pytest -q

      - name: Add Copilot approval label if CI and additional checks passed
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run || {};
            let prs = run.pull_requests || [];

            // Support manual dispatch by providing a pull_number input
            const inputs = context.payload.inputs;
            if (
              (!prs || prs.length === 0) &&
              inputs &&
              inputs.pull_number
            ) {
              prs = [{ number: parseInt(inputs.pull_number, 10) }];
            }

            if (!prs.length) {
                console.log('No associated pull requests found.');
            }

            for (const pr of prs) {
              const prNumber = pr.number;

              // Fetch PR details to inspect draft status and metadata
              const prDetailsResp = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              const prDetails = prDetailsResp.data;

              // Skip drafts
              if (prDetails.draft) {
                console.log(`PR #${prNumber} is a draft; skipping label.`);
                continue;
              }

              // If label already exists, skip
              const labelsResp = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });
              const labels = labelsResp.data.map(l => l.name);

              if (labels.includes('copilot-approved')) {
                console.log(`PR #${prNumber} already labeled copilot-approved.`);
                continue;
              }

              // Add label and post a comment
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['copilot-approved'],
              });

              const commentBody = 'Automated review: CI passed; added label.';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });

              console.log(`Labeled PR #${prNumber} as copilot-approved`);
            }
